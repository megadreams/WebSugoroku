<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no">
<title>WebGL Three.js</title>
<style>
  body {
    width: 640px;
    height: 640px;
    overflow: hidden;
    margin: 0;
    padding: 0;
  }
  </style>
</head>
<body>

  <div id="canvas_frame"></div>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/three.js/three.min.js"></script>
<script src="bower_components/OrbitControls/index.js"></script>
<script src="bower_components/stats.js/build/stats.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="app.js"></script>

<script>


// ====== コンテンツ固有の設定 ====
///- 1: 参加するユーザを作成する class SugorokuUser
///- 2: 表示する3D空間を作成する class ServiceThreejs
///- 3: すごろくパネルを作成する class SugorokuPanel
///- 4: すごろく画面を描画する   class ServiceThreejs

//- 1: すごろくに参加するユーザ情報
var user1 = new SugorokuUser(1, 'Alice');
var user2 = new SugorokuUser(2, 'Christopher');
var user3 = new SugorokuUser(3, 'jasmine');


//- 2: 3D空間の設定
var sceneOptions = {
  isGridHelper:true,
  isAxisHelper:true
};

var cameraOptions = {
  projectionDistance: 70,
  potision: {x:-30, y:40, z:60},
  isMove:true,
  moveOption: { 
    enableZoom:true,
    enableRotate:false,
    enablePan:true
  }
};

var serviceThreejs = new ServiceThreejs('#canvas_frame', window.innerWidth, window.innerHeight);
serviceThreejs.initView();
serviceThreejs.initScene(sceneOptions);
serviceThreejs.initCamera(cameraOptions);


//- 3: すごろくパネル
var sugorokuPanel = new SugorokuPanel();
sugorokuPanel.setPanel(5, 5, 10);


// 生成したパネルに付加情報を設定する
sugorokuPanel.panelList[0].imgUrl = 'img/star01.png';
for (var i=0; i<sugorokuPanel.panelList.length; i++) {
  sugorokuPanel.panelList[i].callback = function() {
    console.log(this.tagName);
  }
}

// 作成したパネルを3D空間に描画させる
for (var i=0; i<sugorokuPanel.panelList.length;i++){
  serviceThreejs.addTextureObject(sugorokuPanel.panelList[i]);
}


var sugorokuGame = new Sugoroku([]);
user1.setPosition(-3, 10, 4);
serviceThreejs.addTextureAnimatorObject(user1.charaObject);
sugorokuGame.addUser(user1);

user2.setPosition(3, 10, 2);
serviceThreejs.addTextureAnimatorObject(user2.charaObject);
sugorokuGame.addUser(user2);

user3.setPosition(0, 10, 2);
serviceThreejs.addTextureAnimatorObject(user3.charaObject);
sugorokuGame.addUser(user3);


//- 4: 描画
serviceThreejs.render();


//- 5: ゲームスタート

var index = 0;
var timerId = null;
$('#canvas_frame').bind('touchstart', function() {

  // アニメーション中は何もしない
  if (timerId) return false;

  var user = sugorokuGame.getCurrentUser();

  var diceNumber = sugorokuGame.turnTheDice();
  console.log(diceNumber);
  var runNumber = 0;

  // アニメーションの実行
  timerId = setInterval(function() {
      if (runNumber < diceNumber) {
        runNumber++;
        var nextIndex = sugorokuPanel.nextPanelIndex(user.currentIndex);

        // 位置の更新
        user.currentIndex = nextIndex;
        // パネルの位置を取得
        var position = sugorokuPanel.getPannelPosition(nextIndex);

        // 位置を指定
        user.setMovePosition(position.x, position.y, position.z);

        // ServiceThreejsに登録しているユーザ情報を更新する
        serviceThreejs.updateRunnerObject(user.userId, user);

        // すごろくゲームに登録しているユーザ情報を更新する
        sugorokuGame.updateCurrentUser(user);

      } else {
        clearInterval(timerId);
        timerId = null;
        sugorokuGame.nextUser();
      }
  }, 300);


  /*
  // ユーザ1の次のパネル情報
  var nextIndex = sugorokuPanel.nextPanelIndex(user.currentIndex);

  // 位置の更新
  user.currentIndex = nextIndex;
  // パネルの位置を取得
  var position = sugorokuPanel.getPannelPosition(nextIndex);

  // 位置を指定
  user.setMovePosition(position.x, position.y, position.z);

  // ServiceThreejsに登録しているユーザ情報を更新する
  serviceThreejs.updateRunnerObject(user.userId, user);

  // すごろくゲームに登録しているユーザ情報を更新する
  sugorokuGame.updateCurrentUser(user);
  */

});




/*
function main() {
};
window.addEventListener('DOMContentLoaded', main, false );
*/

// 参考: https://html5experts.jp/yomotsu/5225/


</script>

</body>
</html>
