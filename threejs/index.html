<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="user-scalable=no">
<title>WebGL Three.js</title>
<style>
  body {
    width: 640px;
    height: 640px;
    overflow: hidden;
    margin: 0;
    padding: 0;
  }
  </style>
</head>
<body>

  <div id="canvas_frame"></div>

<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/three.js/three.min.js"></script>
<script src="bower_components/OrbitControls/index.js"></script>
<script src="bower_components/stats.js/build/stats.min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="app.js"></script>

<script>


// ====== コンテンツ固有の設定 ====
///- 1: 参加するユーザを作成する class SugorokuUser
///- 2: 表示する3D空間を作成する class ServiceThreejs
///- 3: すごろくパネルを作成する class SugorokuPanel
///- 4: すごろく画面を描画する   class ServiceThreejs

//- 1: すごろくに参加するユーザ情報
var user1 = new SugorokuUser(1, 'Alice');
var user2 = new SugorokuUser(2, 'Christopher');
var user3 = new SugorokuUser(3, 'jasmine');


//- 2: 3D空間の設定
var sceneOptions = {
  isGridHelper:true,
  isAxisHelper:true
};

var cameraOptions = {
  potision: {x:0, y:20, z:45},
  isMove:true,
  moveOption: { 
    enableZoom:true,
    enableRotate:false,
    enablePan:true
  }
};

var serviceThreejs = new ServiceThreejs('#canvas_frame', window.innerWidth, window.innerHeight);
serviceThreejs.initView();
serviceThreejs.initScene(sceneOptions);
serviceThreejs.initCamera(cameraOptions);


//- 3: すごろくパネル
var sugorokuPanel = new SugorokuPanel();
sugorokuPanel.setPanel(6, 3, 10);


// 生成したパネルに付加情報を設定する
sugorokuPanel.panelList[0].imgUrl = 'img/star01.png';
for (var i=0; i<sugorokuPanel.panelList.length; i++) {
  sugorokuPanel.panelList[i].callback = function() {
    console.log(this.tagName);
  }
}

// 作成したパネルを3D空間に描画させる
for (var i=0; i<sugorokuPanel.panelList.length;i++){
  serviceThreejs.addTextureObject(sugorokuPanel.panelList[i]);
}


user1.setPosition(-3, 10, 4);
serviceThreejs.addTextureAnimatorObject(user1.charaObject);
user2.setPosition(3, 10, 2);
serviceThreejs.addTextureAnimatorObject(user2.charaObject);

//- 4: 描画
serviceThreejs.render();


var index = 0;
$('#canvas_frame').bind('touchstart', function() {

  console.log(user1.currentIndex);
  // ユーザ1の次のパネル情報
  var nextIndex = sugorokuPanel.nextPanelIndex(user1.currentIndex);
  console.log(nextIndex);
  // 位置の更新
  user1.currentIndex = nextIndex;
  // パネルの位置を取得
  var position = sugorokuPanel.getPannelPosition(nextIndex);
  console.log(position);

  // 位置を指定
  user1.setMovePosition(position.x, position.y, position.z);
});






function main() {
};
window.addEventListener('DOMContentLoaded', main, false );



// 参考: https://html5experts.jp/yomotsu/5225/

function init_object(){
 


    var runnerTexture = new THREE.ImageUtils.loadTexture( 'img/run.png' );
    runnerAnnie = new TextureAnimator( runnerTexture, 10, 1, 10, 75 ); // texture, #horiz, #vert, #total, duration.
    var runnerMaterial = new THREE.MeshBasicMaterial( { map: runnerTexture, side:THREE.DoubleSide, transparent: true } );
    var runnerGeometry = new THREE.PlaneGeometry(15, 15, 1, 1);
    runner = new THREE.Mesh(runnerGeometry, runnerMaterial);
    runner.position.set(0,8,0);
    runner.rotation.set(0, Math.PI, 0);



    runner.isAnimation = false;
    runner.to_x = runner.position.x;
    runner.to_y = runner.position.y;
    runner.to_z = runner.position.z;

    runner.cb = function() {
      console.log('=====');
      console.log(this);
      if (this.isAnimation) {
        var isAnimation = false;
        // 0で無ければ移動
        if ((this.position.x - this.to_x) !== 0) {
          isAnimation = true;
          // 正負どちらに移動するか
          if ((this.to_x - this.position.x) > 0) {
            this.position.x++;
            direct = 'right';
          } else {
            this.position.x--
            direct = 'left';
          }
        }
        // 0で無ければ移動
        if ((this.position.y - this.to_y) !== 0) {
          isAnimation = true;
          // 正負どちらに移動するか
          if ((this.to_y - this.position.y) > 0) {
            this.position.y++;
          } else {
            this.position.y--
          }
        }
        // 0で無ければ移動
        if ((this.position.z - this.to_z) !== 0) {
          isAnimation = true;
          // 正負どちらに移動するか
          if ((this.to_z - this.position.z) > 0) {
            this.position.z++;
            direct = 'up';
          } else {
            this.position.z--
            direct = 'down';
          }
        }

        // 回転する必要があるか？
          switch(direct) {
            case 'up':
              this.rotation.y = Math.PI/2;
              break;
            case 'down':
              this.rotation.y = -Math.PI/2;
              break;
            case 'right':
              this.rotation.y = Math.PI;
              break;
            case 'left':
              this.rotation.y = 0;
              break;
          }
      }
      this.isAnimation = isAnimation;

    };

    scene.add(runner);



}



function runAnimation() {
    console.log('onTouchStart');
    index++;
    if (index >= panelList.length) {
      index = 0;
    }
    var panel = panelList[index];
    console.log('======');

    console.log(index);
    console.log(panel);
    
    runner.to_x = panel.position.x;
//    runner.to_y = panel.position.y;
    runner.to_z = panel.position.z;

    runner.isAnimation = true;
}

//setInterval(runAnimation, 200);
</script>

</body>
</html>
